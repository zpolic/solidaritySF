{% extends 'base.html.twig' %}

{% block body %}
    {% import "macro.html.twig" as macro %}
    {{ macro.back('home') }}

    <div class="card card-lg bg-base-100 shadow m-4 mt-0">
        <div class="card-body">
            <h2 class="card-title mb-4">
                <span class="ti ti-credit-card-pay text-2xl"></span>
                Instrukcije za uplatu
            </h2>

            <div class="text-gray-500 mb-4">
                Na ovoj stranici možete videti spisak svih vaših instrukcija za uplatu ka oštećenim prosvetnim radnicima, potvrditi izvršene uplate i po želji dodati potvrdu o plaćanju za svaku pojedinačnu instrukciju.
            </div>

            {{ include('flashes.html.twig') }}

            {% if transactions.total == 0 %}
                <div class="alert alert-info alert-soft">
                    <span class="ti ti-info-circle text-2xl"></span>
                    <span>Trenutno nema nijedne instrukcije za uplatu, kada sistem bude kreirao nove instrukcije bićete obavešteni na email.</span>
                </div>
            {% else %}
                {% if hasCancelledTransactions %}
                    <div class="alert alert-info alert-soft">
                        <span class="ti ti-info-circle text-2xl"></span>

                        <span>
                            <span class="font-bold block">Neke od vaših instrukcija za uplatu su otkazane?</span> Do otkazivanja dolazi kada sistem automatski poništio instrukciju. Nemojte da britene, ovo je normalna korekcija koja se može desiti. Biće vam prosleđena nova instrukcija za uplatu uskoro.
                        </span>
                    </div>
                {% endif %}

                {% if hasNotPaidTransactions %}
                    <div class="alert alert-info alert-soft">
                        <span class="ti ti-info-circle text-2xl"></span>

                        <span>
                            <span class="font-bold block">Neke od vaših instrukcija za uplatu su u statusu "Uplata nije primljena"?</span> Ukoliko je ovo greška, molimo Vas da nam pošaljete dokaz o uplati na email adresu: <a href="mailto:donatori@mrezasolidarnosti.org" target="_blank" class="link link-primary link-hover">donatori@mrezasolidarnosti.org</a>
                        </span>
                    </div>
                {% endif %}

                {% if hasExpiredTransactions %}
                    <div class="alert alert-info alert-soft">
                        <span class="ti ti-info-circle text-2xl"></span>

                        <span>
                            <span class="font-bold block">Neke od vaših instrukcija za uplatu su istekle?</span> Do isteka instrukcija za uplatu dolazi kada prođe više od 72 sata bez potvrde donatora da je uplata izvršena. Ukoliko ste ipak izvršili uplatu bez da ste je potvrdili, nema razloga za brigu, administrator će proveriti sve instrukcije i ukoliko je plaćena status će joj biti promenjen.
                        </span>
                    </div>
                {% endif %}

                <div class="overflow-x-auto mt-4">
                    <div class="text-gray-500 mb-2 total-results">
                        Ukupno rezultata: <span class="font-bold">{{ transactions.total }}</span>
                    </div>

                    <table class="table rounded-xl border border-base-200 responsive-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th>
                                    <span class="ti ti-school text-xl"></span>
                                    Oštećeni/a
                                </th>
                                <th>
                                    <span class="ti ti-building-community text-xl"></span>
                                    Grad
                                </th>
                                <th>
                                    <span class="ti ti-credit-card text-xl"></span>
                                    Broj računa
                                </th>
                                <th>
                                    <span class="ti ti-cash text-xl"></span>
                                    Iznos
                                </th>
                                <th>Poziv na broj</th>
                                <th>
                                    <span class="ti ti-calendar-event text-xl"></span>
                                    Kreirano
                                </th>
                                <th>
                                    Status

                                    <a href="{{ path('static_transaction_status') }}" class="link link-primary no-underline">
                                        <span class="ti ti-info-circle text-xl"></span>
                                    </a>
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for transaction in transactions.items %}
                            <tr class="hover:bg-gray-100">
                                <td data-label="Oštećeni/a">
                                    {% if transaction.isMaskInformation %}
                                        <span class="text-gray-500 tracking-widest">{{ transaction.damagedEducator.name|mask }}</span>
                                    {% else %}
                                        {{ transaction.damagedEducator.name }}
                                    {% endif %}
                                </td>
                                <td data-label="Grad">
                                    {% if transaction.isMaskInformation %}
                                        <div class="text-gray-500 tracking-widest">{{ transaction.damagedEducator.city.name|mask }}</div>
                                    {% else %}
                                        <div>{{ transaction.damagedEducator.city.name }}</div>
                                    {% endif %}
                                </td>
                                <td class="whitespace-nowrap" data-label="Broj računa">
                                    {% if transaction.isMaskInformation %}
                                        <span class="text-gray-500 tracking-widest">{{ transaction.accountNumber|mask }}</span>
                                    {% else %}
                                        {{ transaction.accountNumber|account_number_format }}
                                    {% endif %}
                                </td>
                                <td data-label="Iznos">{{ transaction.amount|number_format }}</td>
                                <td data-label="Poziv na broj">{{ transaction.referenceCode }}</td>
                                <td data-label="Kreirano">{{ transaction.createdAt|date('d.m.Y.') }}</td>
                                <td class="min-w-[180px] break-words whitespace-normal" data-label="Status">
                                    {{ transaction.status|transaction_status|raw }}
                                </td>
                                <td class="whitespace-nowrap" data-label="">
                                    <div class="flex flex-col gap-4 md:flex-row md:gap-2 justify-end">
                                        <a href="#" class="btn {% if transaction.allowShowQR %}btn-primary{% else %}btn-disabled{% endif %} btn-sm flex w-full md:w-auto tooltip" data-tip="NBS QR" onclick="openQrModal('{{ transaction.id }}'); return false;">
                                            <span class="ti ti-qrcode text-xl"></span> NBS QR
                                        </a>

                                        <a href="{{ path('donor_transaction_print', { 'id': transaction.id }) }}" target="_blank" class="btn {% if transaction.allowShowPrint %}btn-primary{% else %}btn-disabled{% endif %} btn-sm flex w-full md:w-auto tooltip" data-tip="Odštampaj">
                                            <span class="ti ti-printer text-xl"></span>
                                            <span class="inline md:hidden">Odštampaj</span>
                                        </a>

                                        {% if transaction.isStatusWaitingConfirmation %}
                                            <a href="{{ path('donor_transaction_delete_payment_confirmation', { 'id': transaction.id }) }}" class="btn {% if transaction.allowDeletePaymentConfirmation %}btn-error{% else %}btn-disabled{% endif %} btn-sm flex w-full md:w-auto">
                                                <span class="ti ti-square-x text-xl"></span> Obriši potvrdu
                                            </a>
                                        {% else %}
                                            <a href="{{ path('donor_transaction_confirm_payment', { 'id': transaction.id }) }}" class="btn {% if transaction.allowConfirmPayment %}btn-primary{% else %}btn-disabled{% endif %} btn-sm flex w-full md:w-auto">
                                                <span class="ti ti-checkbox text-xl"></span> Potvrdi uplatu
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% import "macro.html.twig" as macro %}
                {{ macro.pagination('donor_transaction_list', transactions.total_pages, transactions.current_page) }}
            {% endif %}
        </div>
    </div>

    <dialog id="qr_modal" class="modal">
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>

        <div class="modal-box" id="qr_modal_box">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>

            <div id="qr_modal_content"></div>
        </div>
    </dialog>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        function openQrModal(transactionId) {
            const modal = document.getElementById('qr_modal');
            const contentDiv = document.getElementById('qr_modal_content');
            contentDiv.innerHTML = '<div class="text-center my-4">Učitavanje...</div>';

            fetch('/instrukcije-za-uplatu/qr/' + transactionId)
                .then(response => response.text())
                .then(html => {
                    contentDiv.innerHTML = html;
                })
                .catch(() => {
                    contentDiv.innerHTML = '<div class="text-error">Greška pri učitavanju QR koda.</div>';
                });

            modal.showModal();
        }
    </script>
{% endblock %}
